---
name: ✅ 开发任务
about: 项目中的开发/实现任务
title: "[Task] 📊 创建数据库验证测试框架"
labels: task,testing,database
assignees: ""
---

## 功能 / 任务标题
> 创建数据库操作真实性和完整性验证测试框架

### 需求依据
- 需要验证API操作对数据库的真实影响（避免返回假数据）
- 当前已有基础数据库验证脚本（`verify_database_integrity.sh`）
- 缺少数据一致性和性能验证机制
- 需要确保数据库操作的完整性和准确性
- 前置任务：🔐 构建权限与安全测试体系

### 具体操作
1. **整合现有数据库验证脚本到新框架**
   - `verify_database_integrity.sh` → `scripts/database/db_integrity_test.sh`
   - 数据库操作真实性验证（API操作后数据确实变化）
   - 数据完整性检查（外键约束、数据关联）
   - 集成到统一的测试运行器

2. **实现数据一致性检查**
   - 外键约束验证（确保数据引用完整性）
   - 数据关联性检查（订单与订单项、用户与订单关系）
   - 事务完整性验证（复杂操作的数据一致性）
   - 数据状态验证（订单状态、菜品状态等业务规则）

3. **添加性能监控测试**
   - 查询响应时间测试（慢查询识别）
   - 并发操作测试（多用户同时操作数据库）
   - 数据库连接池测试（连接管理和效率）
   - 索引效率测试（查询优化建议）

4. **建立测试数据生命周期管理**
   - 测试数据初始化（创建标准测试数据集）
   - 测试后数据清理（恢复测试前状态）
   - 数据状态快照（测试前后数据对比）
   - 测试数据版本控制（不同版本的测试数据）

### 交付物
- 数据库验证测试套件 (`scripts/database/`)
- 数据一致性检查工具
- 性能监控脚本
- 测试数据生命周期管理工具
- 数据库测试报告模板
- 数据库测试执行指南

### 验收
1. **功能调用结果符合需求**
   - 可以验证API操作的真实数据库影响
   - 数据一致性检查自动化识别异常
   - 性能测试提供可量化的结果
   - 测试数据管理自动化无残留

2. **测试数据正确写入 / 返回**
   - 数据库操作验证准确记录
   - 性能指标正确收集和分析
   - 数据一致性问题准确识别
   - 测试报告数据统计正确

3. **项目启动后无报错**
   - 所有数据库测试脚本可独立运行
   - 测试数据管理不冲突其他测试
   - 性能测试不影响系统稳定性
   - 与其他测试模块协同工作

### 任务关联
- **前置任务**: 🔐 构建权限与安全测试体系
- **后续任务**:
  - 🔄 实现业务流程集成测试
  - 📈 建立持续集成测试流程

### 数据库测试要求
基于系统的5张核心表结构：

**administrators表测试**:
- 用户创建、更新、删除操作验证
- 权限字段（role）正确性验证
- 密码加密存储验证

**ltypes表测试**:
- 分类创建、更新、删除操作验证
- 分类锁定状态（catelock）验证
- 分类关联菜品数量验证

**menu表测试**:
- 菜品创建、更新、删除操作验证
- 菜品状态（productLock）验证
- 菜品销量（xiaoliang）更新验证
- 菜品价格（price、hotPrice）验证

**cg_info表测试**:
- 订单创建、更新、删除操作验证
- 订单状态（status）变更验证
- 订单总价（totalprice）计算验证
- 订单与用户关联验证

**the_order_entry表测试**:
- 订单项创建、更新、删除操作验证
- 订单项与订单关联验证
- 订单项价格计算验证
- 菜品销量更新验证

### 性能测试要求
- **查询性能**: 关键查询响应时间 < 1秒
- **并发性能**: 支持10个并发用户操作
- **连接池**: 连接池使用率 < 80%
- **数据完整性**: 复杂操作后数据一致性100%

### 备注
数据库验证是确保系统数据正确性的关键环节，需要特别关注业务规则的数据验证。
当前发现订单创建等核心功能存在数据库操作问题，需要在后续开发中重点关注。
此任务将建立完整的数据库测试体系，确保所有数据操作的真实性和完整性。

### 数据安全提示
- 测试时使用专用的测试数据库
- 不要在生产环境中运行数据库测试
- 测试数据要包含各种边界情况
- 注意保护敏感数据（如用户密码）

### 测试数据要求
需要创建标准测试数据集：
- 至少3个不同权限的用户
- 每个分类下至少2个菜品
- 不同状态的订单（待受理、处理中、已完成、已取消）
- 完整的订单项数据