# Web订餐管理系统自动化测试框架使用指南

## 概述

本文档介绍Web订餐管理系统的自动化测试框架，该框架设计用于提供全面的API测试、安全测试、数据库测试和集成测试能力。

## 目录结构

```
test-framework/
├── docs/                          # 测试文档
│   ├── 测试框架使用指南.md         # 本文档
│   ├── API测试规范.md              # API测试标准
│   ├── 权限测试规范.md              # 权限测试标准
│   └── 测试报告模板.md              # 报告生成模板
├── scripts/                        # 测试脚本
│   ├── core/                       # 核心测试库
│   │   ├── test_runner.sh          # 测试运行器
│   │   ├── auth_manager.sh         # 认证管理
│   │   ├── data_manager.sh         # 测试数据管理
│   │   └── report_generator.sh     # 报告生成器
│   ├── api/                        # API测试脚本
│   │   ├── basic_api_test.sh       # 基础API测试
│   │   ├── menu_api_test.sh        # 菜单API测试
│   │   ├── order_api_test.sh       # 订单API测试
│   │   └── user_api_test.sh        # 用户API测试
│   ├── security/                   # 安全测试脚本
│   │   ├── permission_test.sh      # 权限测试
│   │   ├── privilege_escalation_test.sh  # 越权测试
│   │   └── authentication_test.sh   # 认证测试
│   ├── database/                   # 数据库测试脚本
│   │   ├── db_integrity_test.sh    # 数据库完整性测试
│   │   ├── data_validation_test.sh # 数据验证测试
│   │   └── performance_test.sh     # 性能测试
│   └── integration/                 # 集成测试脚本
│       ├── business_flow_test.sh   # 业务流程测试
│       └── end_to_end_test.sh      # 端到端测试
├── config/                         # 测试配置
│   ├── test_config.yml             # 测试环境配置
│   ├── api_endpoints.yml           # API端点配置
│   └── test_data.yml               # 测试数据配置
├── data/                           # 测试数据
│   ├── seed_data.sql               # 基础测试数据
│   ├── test_scenarios.yml          # 测试场景配置
│   └── expected_results.yml        # 预期结果配置
└── reports/                        # 测试报告目录
    └── templates/                  # 报告模板
        ├── api_report_template.md
        ├── security_report_template.md
        └── integration_report_template.md
```

## 快速开始

### 1. 环境准备

确保以下环境已经准备就绪：

```bash
# 检查必要的工具
which curl        # HTTP请求工具
which mysql        # 数据库客户端
which jq           # JSON处理工具
which bc           # 数学计算工具

# 检查Java环境（运行Spring Boot应用）
java -version

# 检查网络连接
curl -f http://localhost:8080/WebOrderSystem/api-docs
```

### 2. 启动测试环境

```bash
# 进入项目根目录
cd /home/chhsich/Git/Mine/order-management-system

# 启动后端服务
cd backend
./mvnw spring-boot:run &
sleep 30  # 等待服务启动

# 验证服务启动
curl -f http://localhost:8080/WebOrderSystem/api-docs
```

### 3. 运行基础测试

```bash
# 返回项目根目录
cd ..

# 运行完整的API测试套件
./test_backend_api.sh

# 运行权限测试
./test_permissions.sh

# 运行数据库完整性验证
./verify_database_integrity.sh
```

## 测试框架详细使用

### 1. 核心测试运行器

测试运行器 `scripts/core/test_runner.sh` 是框架的核心组件，提供统一的测试执行接口：

```bash
# 使用测试运行器执行所有测试
./test-framework/scripts/core/test_runner.sh --all

# 执行特定类型的测试
./test-framework/scripts/core/test_runner.sh --type api
./test-framework/scripts/core/test_runner.sh --type security
./test-framework/scripts/core/test_runner.sh --type database
./test-framework/scripts/core/test_runner.sh --type integration

# 执行特定测试文件
./test-framework/scripts/core/test_runner.sh --file user_api_test.sh

# 生成详细报告
./test-framework/scripts/core/test_runner.sh --report detailed

# 并行执行测试
./test-framework/scripts/core/test_runner.sh --parallel
```

### 2. 配置管理

测试框架使用YAML文件进行配置管理，便于不同环境的切换：

#### 测试环境配置 (config/test_config.yml)
```yaml
environment: test
database:
  host: localhost
  port: 3306
  name: web_order
  user: root
  password: "123456"

api:
  base_url: http://localhost:8080/WebOrderSystem
  timeout: 30
  retry_count: 3

logging:
  level: INFO
  file: logs/test_framework.log
  console: true
```

#### API端点配置 (config/api_endpoints.yml)
```yaml
endpoints:
  user:
    register:
      path: /api/user/register
      method: POST
      auth: none
    login:
      path: /api/user/login
      method: POST
      auth: none
    me:
      path: /api/user/me
      method: GET
      auth: user

  menu:
    categories:
      path: /api/categories
      method: GET
      auth: none
    category_detail:
      path: /api/categories/{id}
      method: GET
      auth: none
```

### 3. 测试数据管理

测试框架提供了完整的测试数据生命周期管理：

```bash
# 初始化测试数据
./test-framework/scripts/core/data_manager.sh init

# 清理测试数据
./test-framework/scripts/core/data_manager.sh clean

# 创建特定测试场景的数据
./test-framework/scripts/core/data_manager.sh create-scenario user_registration

# 验证数据状态
./test-framework/scripts/core/data_manager.sh verify
```

### 4. 测试报告生成

框架支持多种格式的测试报告：

```bash
# 生成Markdown格式报告
./test-framework/scripts/core/report_generator.sh --format markdown

# 生成HTML格式报告
./test-framework/scripts/core/report_generator.sh --format html

# 生成JSON格式报告（用于程序处理）
./test-framework/scripts/core/report_generator.sh --format json

# 生成包含历史对比的报告
./test-framework/scripts/core/report_generator.sh --with-history
```

## 测试类型详解

### 1. API测试

API测试验证各个API端点的功能正确性：

```bash
# 运行用户相关API测试
./test-framework/scripts/api/user_api_test.sh

# 运行菜单相关API测试
./test-framework/scripts/api/menu_api_test.sh

# 运行订单相关API测试
./test-framework/scripts/api/order_api_test.sh

# 运行基础API测试（所有模块）
./test-framework/scripts/api/basic_api_test.sh
```

### 2. 安全测试

安全测试验证系统的权限控制和安全性：

```bash
# 运行权限测试
./test-framework/scripts/security/permission_test.sh

# 运行越权测试
./test-framework/scripts/security/privilege_escalation_test.sh

# 运行认证测试
./test-framework/scripts/security/authentication_test.sh
```

**权限测试覆盖**:
- **游客权限**: 只能访问公开API（分类查询等）
- **会员权限**: 可以访问用户相关API
- **管理员权限**: 可以访问所有API
- **越权防护**: 验证各角色无法访问未授权API

### 3. 数据库测试

数据库测试验证数据操作的真实性和完整性：

```bash
# 运行数据库完整性测试
./test-framework/scripts/database/db_integrity_test.sh

# 运行数据验证测试
./test-framework/scripts/database/data_validation_test.sh

# 运行性能测试
./test-framework/scripts/database/performance_test.sh
```

### 4. 集成测试

集成测试验证完整的业务流程：

```bash
# 运行业务流程测试
./test-framework/scripts/integration/business_flow_test.sh

# 运行端到端测试
./test-framework/scripts/integration/end_to_end_test.sh
```

**业务流程测试覆盖**:
- **用户端流程**: 注册 → 登录 → 浏览 → 下单 → 支付
- **管理端流程**: 登录 → 用户管理 → 菜单管理 → 订单管理
- **异常流程**: 网络中断、数据冲突、权限越权处理

## 自定义测试开发

### 1. 创建新的测试脚本

基于模板创建新的测试脚本：

```bash
# 复制测试脚本模板
cp test-framework/scripts/core/test_template.sh test-framework/scripts/api/custom_test.sh

# 编辑测试脚本
vim test-framework/scripts/api/custom_test.sh
```

### 2. 测试脚本结构

```bash
#!/bin/bash

# 引入测试框架核心库
source "$(dirname "$0")/../core/test_framework.sh"

# 测试配置
TEST_NAME="自定义测试"
TEST_DESCRIPTION="描述测试的目的和范围"

# 测试数据
TEST_DATA='{"username":"testuser","password":"123456"}'

# 测试函数
test_custom_function() {
    local test_case="$1"
    local expected_code="$2"

    log_info "执行测试用例: $test_case"

    # 执行API调用
    response=$(curl -s -w "HTTP_CODE:%{http_code}" \
        -H "Content-Type: application/json" \
        -d "$TEST_DATA" \
        "$API_BASE/api/custom/endpoint")

    # 验证结果
    verify_response "$response" "$expected_code"
}

# 主测试流程
main() {
    log_start "$TEST_NAME"

    # 初始化测试环境
    setup_test_environment

    # 执行测试用例
    test_custom_function "正常情况" 200
    test_custom_function "错误情况" 400

    # 清理测试环境
    cleanup_test_environment

    log_end "$TEST_NAME"
}

# 执行主函数
main "$@"
```

### 3. 使用测试辅助函数

框架提供了一些辅助函数简化测试开发：

```bash
# 日志函数
log_info "信息消息"
log_error "错误消息"
log_warn "警告消息"

# 测试验证函数
verify_response "$response" "$expected_code"
verify_json_field "$json_response" "$field_name" "$expected_value"
verify_database_count "$table" "$condition" "$expected_count"

# 认证函数
get_auth_token "$username" "$password"
clear_auth_token

# 数据管理函数
create_test_user "$username" "$role"
delete_test_user "$username"
create_test_order "$username" "$items"
```

## 故障排除

### 1. 常见问题

**服务启动失败**:
```bash
# 检查端口占用
netstat -tlnp | grep 8080

# 检查Java进程
ps aux | grep java

# 查看应用日志
tail -f logs/web-order-system.log
```

**数据库连接失败**:
```bash
# 测试数据库连接
mysql -h localhost -u root -p123456 -e "USE web_order; SELECT 1;"

# 检查数据库状态
systemctl status mysql
```

**测试失败**:
```bash
# 查看详细测试日志
tail -f logs/test_framework.log

# 检查测试环境
./test-framework/scripts/core/test_runner.sh --check-env

# 重新初始化测试数据
./test-framework/scripts/core/data_manager.sh reset
```

### 2. 调试模式

框架支持详细的调试模式：

```bash
# 启用调试模式
export DEBUG_TEST_FRAMEWORK=1

# 运行测试并输出详细日志
./test-framework/scripts/core/test_runner.sh --debug

# 只输出失败测试的详细信息
./test-framework/scripts/core/test_runner.sh --errors-only
```

### 3. 性能优化

**并行测试执行**:
```bash
# 启用并行执行
export TEST_PARALLEL=4
./test-framework/scripts/core/test_runner.sh --parallel
```

**测试数据缓存**:
```bash
# 启用数据缓存
export TEST_DATA_CACHE=1
./test-framework/scripts/core/test_runner.sh --cache
```

## 最佳实践

### 1. 测试开发

- **独立性**: 每个测试应该独立运行，不依赖其他测试的状态
- **可重复性**: 测试应该可以重复执行并产生相同的结果
- **明确性**: 测试名称和描述应该清楚说明测试的目的
- **完整性**: 测试应该覆盖正常情况和异常情况

### 2. 测试数据管理

- **隔离性**: 使用专用的测试数据，避免影响生产数据
- **清理机制**: 测试完成后自动清理测试数据
- **数据完整性**: 确保测试数据符合业务规则和约束

### 3. 测试执行

- **定期执行**: 建立定期的测试执行机制
- **失败分析**: 及时分析测试失败的原因并修复
- **持续改进**: 根据测试结果不断改进测试覆盖范围

## 贡献指南

### 1. 添加新测试

1. 确定测试类型和范围
2. 创建相应的测试脚本
3. 更新配置文件（如需要）
4. 测试脚本的功能正确性
5. 提交PR并描述测试内容

### 2. 框架改进

如果发现框架需要改进的地方：
1. 在GitHub Issues中创建改进建议
2. 描述具体的问题和改进方案
3. 提供代码示例（如果可能）
4. 参与讨论和实现

## 支持和反馈

如果在使用测试框架时遇到问题：
1. 查看本文档的故障排除部分
2. 检查GitHub Issues中是否有类似问题
3. 创建新的Issue描述问题详情
4. 提供相关的日志和错误信息

---

**文档版本**: 1.0
**最后更新**: 2025-09-17
**维护者**: Web订餐管理系统开发团队