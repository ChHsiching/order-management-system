# Web订餐管理系统 权限测试规范

## 概述

本文档定义了Web订餐管理系统的权限测试标准和规范，基于PDF文档中规定的三种用户角色权限要求，确保系统的安全性和访问控制。

## 权限角色定义

### 1. 游客 (Guest)
- **身份**: 未登录用户
- **权限**: 只能访问公开的API端点
- **限制**: 无法访问需要认证的功能

### 2. 会员 (Member)
- **身份**: 已登录的普通用户
- **权限**: 包含游客所有权限 + 用户管理功能
- **限制**: 无法访问管理员功能

### 3. 管理员 (Admin)
- **身份**: 已登录的系统管理员
- **权限**: 包含会员所有权限 + 完整的管理功能
- **限制**: 无特殊限制

## 权限矩阵

### 1. 用户管理权限
| API端点 | 方法 | 游客 | 会员 | 管理员 | 描述 |
|---------|------|------|------|--------|------|
| `/api/user/register` | POST | ❌ | ❌ | ❌ | 用户注册（公开接口） |
| `/api/user/login` | POST | ❌ | ❌ | ❌ | 用户登录（公开接口） |
| `/api/user/me` | GET | 401 | 200 | 200 | 获取当前用户信息 |
| `/api/user/update` | PUT | 401 | 200 | 200 | 更新用户信息 |
| `/api/user/password` | PUT | 401 | 200 | 200 | 修改密码 |
| `/api/admin/users` | GET | 401 | 403 | 200 | 获取用户列表 |
| `/api/admin/users/{id}` | GET | 401 | 403 | 200 | 获取用户详情 |
| `/api/admin/users/{id}` | PUT | 401 | 403 | 200 | 更新用户信息 |
| `/api/admin/users/{id}` | DELETE | 401 | 403 | 200 | 删除用户 |

### 2. 菜单管理权限
| API端点 | 方法 | 游客 | 会员 | 管理员 | 描述 |
|---------|------|------|------|--------|------|
| `/api/categories` | GET | 200 | 200 | 200 | 获取分类列表 |
| `/api/categories/{id}` | GET | 200 | 200 | 200 | 获取分类详情 |
| `/api/menu/list` | GET | 200 | 200 | 200 | 获取菜品列表 |
| `/api/menu/{id}` | GET | 200 | 200 | 200 | 获取菜品详情 |
| `/api/menu/search` | GET | 200 | 200 | 200 | 搜索菜品 |
| `/api/menu/recommend` | GET | 200 | 200 | 200 | 获取推荐菜品 |
| `/api/admin/categories` | POST | 401 | 403 | 201 | 创建分类 |
| `/api/admin/categories/{id}` | PUT | 401 | 403 | 200 | 更新分类 |
| `/api/admin/categories/{id}` | DELETE | 401 | 403 | 200 | 删除分类 |
| `/api/admin/menu` | POST | 401 | 403 | 201 | 创建菜品 |
| `/api/admin/menu/{id}` | PUT | 401 | 403 | 200 | 更新菜品 |
| `/api/admin/menu/{id}` | DELETE | 401 | 403 | 200 | 删除菜品 |

### 3. 订单管理权限
| API端点 | 方法 | 游客 | 会员 | 管理员 | 描述 |
|---------|------|------|------|--------|------|
| `/api/order/create` | POST | 401 | 201 | 201 | 创建订单 |
| `/api/order/list` | GET | 401 | 200 | 200 | 获取订单列表 |
| `/api/order/{id}` | GET | 401 | 200 | 200 | 获取订单详情 |
| `/api/order/{id}/status` | PUT | 401 | 200 | 200 | 更新订单状态 |
| `/api/order/{id}/cancel` | PUT | 401 | 200 | 200 | 取消订单 |
| `/api/admin/orders` | GET | 401 | 403 | 200 | 获取所有订单 |
| `/api/admin/orders/{id}` | PUT | 401 | 403 | 200 | 管理员更新订单 |

### 4. 购物车权限
| API端点 | 方法 | 游客 | 会员 | 管理员 | 描述 |
|---------|------|------|------|--------|------|
| `/api/cart/add` | POST | 401 | 200 | 200 | 添加到购物车 |
| `/api/cart/list` | GET | 401 | 200 | 200 | 获取购物车 |
| `/api/cart/update` | PUT | 401 | 200 | 200 | 更新购物车 |
| `/api/cart/{id}` | DELETE | 401 | 200 | 200 | 删除购物车项 |
| `/api/cart/clear` | DELETE | 401 | 200 | 200 | 清空购物车 |

## 测试场景设计

### 1. 正常权限测试
- **游客访问公开API**: 验证游客可以访问分类、菜品查询等公开接口
- **会员访问用户API**: 验证会员可以访问个人信息、订单等用户功能
- **管理员访问管理API**: 验证管理员可以访问所有管理功能

### 2. 越权访问测试
- **游客越权**: 游客尝试访问需要认证的API
- **会员越权**: 会员尝试访问管理员功能
- **管理员越权**: 验证管理员没有不应有的权限

### 3. 会话管理测试
- **登录状态验证**: 验证登录后token的正确性
- **会话超时**: 验证token过期后的处理
- **并发登录**: 验证多设备同时登录的处理
- **会话劫持**: 验证会话安全性

### 4. 边界情况测试
- **无效token**: 测试无效或过期token的处理
- **伪造token**: 测试伪造token的防护
- **权限继承**: 测试权限变更后的生效时间

## 测试用例详细设计

### 1. 游客权限测试
```bash
test_guest_permissions() {
    # ✅ 允许访问的公开API
    test_permission "guest" "分类查询" "GET" "/api/categories" "" 200
    test_permission "guest" "菜品列表" "GET" "/api/menu/list" "" 200
    test_permission "guest" "菜品搜索" "GET" "/api/menu/search?keyword=test" "" 200

    # ❌ 禁止访问的认证API
    test_permission "guest" "用户信息" "GET" "/api/user/me" "" 401
    test_permission "guest" "订单查询" "GET" "/api/order/list" "" 401
    test_permission "guest" "购物车" "GET" "/api/cart/list" "" 401
    test_permission "guest" "管理功能" "GET" "/api/admin/users" "" 401
}
```

### 2. 会员权限测试
```bash
test_member_permissions() {
    # ✅ 允许访问的用户API
    test_permission "member" "个人信息" "GET" "/api/user/me" "" 200
    test_permission "member" "订单创建" "POST" "/api/order/create" '{"items":[],"total_price":0}' 201
    test_permission "member" "订单查询" "GET" "/api/order/list" "" 200
    test_permission "member" "购物车" "GET" "/api/cart/list" "" 200

    # ❌ 禁止访问的管理API
    test_permission "member" "用户管理" "GET" "/api/admin/users" "" 403
    test_permission "member" "菜单管理" "POST" "/api/admin/categories" '{"name":"test"}' 403
    test_permission "member" "订单管理" "GET" "/api/admin/orders" "" 403
}
```

### 3. 管理员权限测试
```bash
test_admin_permissions() {
    # ✅ 允许访问的所有API
    test_permission "admin" "用户管理" "GET" "/api/admin/users" "" 200
    test_permission "admin" "菜单管理" "POST" "/api/admin/categories" '{"name":"test"}' 201
    test_permission "admin" "订单管理" "GET" "/api/admin/orders" "" 200
    test_permission "admin" "系统统计" "GET" "/api/admin/stats" "" 200

    # 验证管理员也可以访问会员功能
    test_permission "admin" "个人信息" "GET" "/api/user/me" "" 200
    test_permission "admin" "订单创建" "POST" "/api/order/create" '{"items":[],"total_price":0}' 201
}
```

### 4. 越权测试
```bash
test_privilege_escalation() {
    # 游客伪造管理员token
    test_permission "guest" "伪造管理员权限" "GET" "/api/admin/users" "" 401

    # 会员伪造管理员token
    test_permission "member" "伪造管理员权限" "GET" "/api/admin/users" "" 403

    # 测试token篡改
    test_permission "member" "token篡改测试" "GET" "/api/admin/users" "" 403
}
```

## 测试数据准备

### 1. 测试用户数据
```yaml
test_users:
  guest:
    description: "未登录用户"
    token: null

  member:
    username: "test_member"
    password: "Member123456"
    email: "member@test.com"
    role: "member"
    token: "generated_jwt_token"

  admin:
    username: "test_admin"
    password: "Admin123456"
    email: "admin@test.com"
    role: "admin"
    token: "generated_jwt_token"
```

### 2. 测试场景数据
```yaml
test_scenarios:
  user_registration:
    description: "用户注册流程"
    steps:
      - 游客访问注册页面
      - 提交注册信息
      - 验证注册成功
      - 自动登录成为会员

  order_creation:
    description: "订单创建流程"
    steps:
      - 会员登录
      - 浏览菜品
      - 添加到购物车
      - 创建订单
      - 验证订单状态

  admin_operations:
    description: "管理员操作流程"
    steps:
      - 管理员登录
      - 查看用户列表
      - 管理菜单分类
      - 处理订单
      - 查看系统统计
```

## 安全测试要求

### 1. 认证安全测试
- **密码加密**: 验证密码是否加密存储
- **登录失败**: 验证登录失败次数限制
- **账户锁定**: 验证账户锁定机制
- **密码强度**: 验证密码复杂度要求

### 2. 会话安全测试
- **token安全性**: 验证JWT token的签名和过期时间
- **会话超时**: 验证会话超时后的处理
- **并发控制**: 验证多设备登录的限制
- **会话清理**: 验证登出后会话正确清理

### 3. 输入验证测试
- **SQL注入**: 测试SQL注入防护
- **XSS攻击**: 测试跨站脚本攻击防护
- **CSRF防护**: 测试跨站请求伪造防护
- **参数验证**: 测试输入参数的合法性验证

## 测试执行规范

### 1. 测试环境配置
```bash
# 设置测试环境变量
export TEST_ENV=testing
export API_BASE=http://localhost:8080/WebOrderSystem
export DB_HOST=localhost
export DB_USER=root
export DB_PASS=123456

# 初始化测试数据
./test-framework/scripts/core/data_manager.sh init

# 运行权限测试
./test-framework/scripts/security/permission_test.sh
```

### 2. 测试执行顺序
1. **环境准备**: 清理测试数据，创建测试用户
2. **基础权限测试**: 验证各角色的基本权限
3. **越权测试**: 验证权限边界的严格控制
4. **会话测试**: 验证会话管理的安全性
5. **数据清理**: 清理测试数据，恢复环境

### 3. 测试结果验证
- **权限矩阵**: 验证所有API端点的权限控制正确
- **错误处理**: 验证越权访问返回正确的错误码
- **日志记录**: 验证权限验证日志记录完整
- **安全性**: 验证没有安全漏洞

## 测试报告要求

### 1. 权限测试报告格式
```markdown
# 权限测试报告

## 测试概览
- 测试时间: 2025-09-17 10:30:00
- 测试API总数: 45
- 权限验证通过: 43
- 权限验证失败: 2
- 通过率: 95.6%

## 权限矩阵验证结果
### 游客权限 (15/15 通过)
- ✅ 分类查询 (200)
- ✅ 菜品列表 (200)
- ❌ 用户信息 (401) - 期望结果
- ...

### 会员权限 (20/20 通过)
- ✅ 个人信息 (200)
- ✅ 订单查询 (200)
- ❌ 用户管理 (403) - 期望结果
- ...

### 管理员权限 (8/8 通过)
- ✅ 用户管理 (200)
- ✅ 菜单管理 (200)
- ✅ 订单管理 (200)
- ...

## 安全测试结果
- JWT token验证: ✅ 通过
- 会话管理: ✅ 通过
- 越权防护: ✅ 通过
- 输入验证: ✅ 通过

## 发现的问题
1. `/api/admin/users` 接口缺少权限验证
2. 游客可以访问部分敏感接口
3. 会员越权访问管理功能

## 修复建议
1. 加强Spring Security配置
2. 实现基于角色的访问控制
3. 添加权限注解验证
```

## 自动化测试脚本

### 1. 权限测试主脚本
```bash
#!/bin/bash
# test-framework/scripts/security/permission_test.sh

source "$(dirname "$0")/../core/test_framework.sh"

test_guest_permissions() {
    log_info "测试游客权限..."

    # 公开API
    test_permission "guest" "分类查询" "GET" "/api/categories" "" 200
    test_permission "guest" "菜品列表" "GET" "/api/menu/list" "" 200
    test_permission "guest" "菜品搜索" "GET" "/api/menu/search?keyword=test" "" 200

    # 认证API - 应该返回401
    test_permission "guest" "用户信息" "GET" "/api/user/me" "" 401
    test_permission "guest" "订单查询" "GET" "/api/order/list" "" 401
    test_permission "guest" "购物车" "GET" "/api/cart/list" "" 401
    test_permission "guest" "用户管理" "GET" "/api/admin/users" "" 401
}

test_member_permissions() {
    log_info "测试会员权限..."

    # 用户API
    test_permission "member" "个人信息" "GET" "/api/user/me" "" 200
    test_permission "member" "订单创建" "POST" "/api/order/create" '{"items":[],"total_price":0}' 201
    test_permission "member" "订单查询" "GET" "/api/order/list" "" 200

    # 管理API - 应该返回403
    test_permission "member" "用户管理" "GET" "/api/admin/users" "" 403
    test_permission "member" "菜单管理" "POST" "/api/admin/categories" '{"name":"test"}' 403
}

test_admin_permissions() {
    log_info "测试管理员权限..."

    # 管理API
    test_permission "admin" "用户管理" "GET" "/api/admin/users" "" 200
    test_permission "admin" "菜单管理" "POST" "/api/admin/categories" '{"name":"test"}' 201
    test_permission "admin" "订单管理" "GET" "/api/admin/orders" "" 200
}

main() {
    log_start "权限测试"

    setup_test_environment

    test_guest_permissions
    test_member_permissions
    test_admin_permissions

    cleanup_test_environment
    log_end "权限测试"
}

main "$@"
```

### 2. 越权测试脚本
```bash
#!/bin/bash
# test-framework/scripts/security/privilege_escalation_test.sh

source "$(dirname "$0")/../core/test_framework.sh"

test_token_tampering() {
    log_info "测试token篡改..."

    # 测试伪造token
    local fake_token="fake_admin_token"
    test_permission "guest" "伪造token" "GET" "/api/admin/users" "" 401

    # 测试过期token
    local expired_token="expired_token"
    test_permission "member" "过期token" "GET" "/api/admin/users" "" 403
}

test_direct_access() {
    log_info "测试直接访问..."

    # 测试直接访问管理接口
    test_permission "guest" "直接访问用户管理" "GET" "/api/admin/users" "" 401
    test_permission "member" "直接访问用户管理" "GET" "/api/admin/users" "" 403
}

main() {
    log_start "越权测试"

    setup_test_environment

    test_token_tampering
    test_direct_access

    cleanup_test_environment
    log_end "越权测试"
}

main "$@"
```

## 持续监控要求

### 1. 定期测试
- **每日测试**: 自动执行权限测试
- **每周报告**: 生成权限测试趋势报告
- **每月审计**: 全面权限安全审计

### 2. 变更检测
- **代码提交**: 新功能必须包含权限测试
- **配置变更**: 权限配置变更后自动测试
- **安全更新**: 安全补丁后重新测试

### 3. 告警机制
- **权限漏洞**: 发现权限漏洞立即告警
- **配置错误**: 权限配置错误告警
- **异常访问**: 异常访问模式告警

---

**文档版本**: 1.0
**最后更新**: 2025-09-17
**维护者**: Web订餐管理系统开发团队