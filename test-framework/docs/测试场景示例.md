# 测试场景示例

本文档提供了Web订餐管理系统测试框架的详细使用示例，涵盖各种测试场景和最佳实践。

## 目录
- [快速开始测试](#快速开始测试)
- [API功能测试](#api功能测试)
- [安全权限测试](#安全权限测试)
- [数据库验证测试](#数据库验证测试)
- [集成业务流程测试](#集成业务流程测试)
- [性能负载测试](#性能负载测试)
- [CI/CD集成](#cicd集成)
- [故障排除指南](#故障排除指南)

## 快速开始测试

### 1. 环境准备

确保以下环境已经准备就绪：

```bash
# 检查必要的服务
curl -f http://localhost:8080/WebOrderSystem/api-docs
mysql -h localhost -u root -p123456 -e "USE web_order; SELECT 1;"

# 检查必要的工具
which curl mysql jq bc
```

### 2. 基础测试运行

```bash
# 进入测试框架目录
cd test-framework/scripts/core

# 检查测试环境
./test_runner.sh --check-env

# 运行所有测试
./test_runner.sh --all

# 生成详细报告
./test_runner.sh --all --report detailed
```

## API功能测试

### 1. 基础API测试

```bash
# 运行所有API测试
./test_runner.sh --type api

# 运行特定的API测试文件
./test_runner.sh --file ../api/basic_api_test.sh

# 启用调试模式
./test_runner.sh --type api --debug
```

### 2. 测试内容覆盖

基础API测试覆盖以下功能：

- **用户管理API**
  - 用户注册 (`POST /api/user/register`)
  - 用户登录 (`POST /api/user/login`)
  - 获取用户信息 (`GET /api/user/me`)

- **菜单管理API**
  - 获取分类列表 (`GET /api/categories`)
  - 获取菜品列表 (`GET /api/menu/list`)
  - 菜品搜索 (`GET /api/menu/search`)
  - 获取推荐菜品 (`GET /api/menu/recommend`)

- **订单管理API**
  - 创建订单 (`POST /api/order/create`)
  - 获取订单列表 (`GET /api/order/list`)
  - 获取订单详情 (`GET /api/order/{id}`)
  - 更新订单状态 (`PUT /api/order/{id}/status`)
  - 取消订单 (`PUT /api/order/{id}/cancel`)

- **购物车API**
  - 添加到购物车 (`POST /api/cart/add`)
  - 获取购物车 (`GET /api/cart/list`)
  - 更新购物车 (`PUT /api/cart/update`)
  - 删除购物车项 (`DELETE /api/cart/{id}`)
  - 清空购物车 (`DELETE /api/cart/clear`)

- **管理员API**
  - 获取用户列表 (`GET /api/admin/users`)
  - 分类管理 (`GET/POST /api/admin/categories`)
  - 菜品管理 (`GET/POST /api/admin/menu`)
  - 订单管理 (`GET /api/admin/orders`)
  - 系统统计 (`GET /api/admin/stats`)

### 3. 测试数据示例

**用户注册测试数据：**
```json
{
  "username": "test_user_1631881200",
  "password": "Test123456",
  "email": "test1631881200@example.com",
  "phone": "13800138001"
}
```

**订单创建测试数据：**
```json
{
  "items": [
    {
      "menu_id": 1,
      "quantity": 2,
      "price": 12.50
    }
  ],
  "total_price": 25.00,
  "address": "测试地址123号",
  "phone": "13800138001"
}
```

## 安全权限测试

### 1. 权限矩阵验证

```bash
# 运行安全测试
./test_runner.sh --type security

# 查看详细的权限测试结果
./test_runner.sh --type security --debug
```

### 2. 角色权限覆盖

**游客权限 (Guest)：**
- ✅ 允许：查看分类、查看菜品列表、搜索菜品、查看推荐
- ❌ 禁止：用户信息、订单查询、购物车操作、管理员功能

**会员权限 (Member)：**
- ✅ 允许：所有游客权限 + 用户信息、订单管理、购物车操作
- ❌ 禁止：管理员功能

**管理员权限 (Admin)：**
- ✅ 允许：所有功能访问

### 3. 安全测试场景

**越权访问测试：**
```bash
# 测试游客访问管理员API
curl -i http://localhost:8080/WebOrderSystem/api/admin/users

# 测试会员访问管理员API
curl -i -H "Authorization: Bearer MEMBER_TOKEN" \
     http://localhost:8080/WebOrderSystem/api/admin/users
```

**输入验证测试：**
```bash
# SQL注入测试
curl -i -X POST http://localhost:8080/WebOrderSystem/api/user/register \
     -H "Content-Type: application/json" \
     -d '{"username":"test'\'' OR '\''1'\''='\''1","password":"test"}'

# XSS攻击测试
curl -i -X GET "http://localhost:8080/WebOrderSystem/api/menu/search?keyword=<script>alert('xss')</script>"
```

## 数据库验证测试

### 1. 数据完整性测试

```bash
# 运行数据库测试
./test_runner.sh --type database

# 运行特定的数据库验证测试
./test_runner.sh --file ../database/db_integrity_test.sh
```

### 2. 数据验证内容

**外键约束验证：**
- 订单项表的外键约束（订单项必须属于有效订单）
- 菜单表的外键约束（菜品必须属于有效分类）
- 订单表的用户外键约束（订单必须属于有效用户）

**数据一致性验证：**
- 订单总价计算一致性
- 菜品销量统计一致性
- 用户数据完整性

**性能基准测试：**
- 数据库查询响应时间 (< 100ms)
- 并发查询处理能力
- 连接池性能测试

### 3. 数据验证SQL示例

```sql
-- 检查孤立订单项
SELECT COUNT(*) FROM the_order_entry
WHERE order_id NOT IN (SELECT id FROM cg_info);

-- 检查订单总价一致性
SELECT COUNT(*) FROM cg_info c
WHERE c.totalprice != (
    SELECT COALESCE(SUM(price * productnum), 0)
    FROM the_order_entry e
    WHERE e.orderid = c.orderid
);

-- 检查菜品销量统计一致性
SELECT COUNT(*) FROM menu m
WHERE m.xiaoliang != (
    SELECT COALESCE(SUM(e.productnum), 0)
    FROM the_order_entry e
    WHERE e.productid = m.id
);
```

## 集成业务流程测试

### 1. 完整用户流程测试

```bash
# 运行集成测试
./test_runner.sh --type integration

# 运行业务流程测试
./test_runner.sh --file ../integration/business_flow_test.sh

# 运行端到端测试
./test_runner.sh --file ../integration/end_to_end_test.sh
```

### 2. 业务流程场景

**完整用户注册到下单流程：**
1. 游客浏览菜品分类和推荐
2. 用户注册并登录
3. 搜索和浏览菜品
4. 添加商品到购物车
5. 创建订单
6. 查看订单状态
7. 验证数据库数据完整性

**管理员操作流程：**
1. 管理员登录
2. 查看系统统计信息
3. 管理用户列表
4. 管理订单列表
5. 管理菜单和分类

**异常情况处理：**
1. 重复用户注册
2. 无效订单数据
3. 并发访问处理
4. 数据约束违反

### 3. 并发测试示例

```bash
# 模拟并发用户访问
./test_runner.sh --type integration --parallel

# 测试负载情况
./test_runner.sh --file ../database/performance_test.sh
```

## 性能负载测试

### 1. 性能测试指标

```bash
# 运行性能测试
./test_runner.sh --file ../database/performance_test.sh

# 查看性能指标
cat reports/test_report_*.md | grep -A 10 -B 5 "性能"
```

### 2. 性能基准

**API响应时间：**
- 优秀: < 500ms
- 良好: < 1000ms
- 需要优化: ≥ 1000ms

**数据库查询时间：**
- 优秀: < 10ms
- 良好: < 50ms
- 需要优化: ≥ 50ms

**并发处理能力：**
- 优秀: < 1000ms (50并发用户)
- 良好: < 3000ms (50并发用户)
- 需要优化: ≥ 3000ms

### 3. 负载测试配置

```bash
# 30秒负载测试
./test_runner.sh --file ../database/performance_test.sh

# 自定义并发测试
export TEST_CONCURRENT_USERS=100
export TEST_DURATION_SECONDS=60
./test_runner.sh --file ../database/performance_test.sh
```

## CI/CD集成

### 1. GitHub Actions集成

```yaml
# .github/workflows/test.yml
name: Automated Testing
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Start backend
        run: |
          cd backend
          ./mvnw spring-boot:run &
          sleep 30
      - name: Run tests
        run: ./test-framework/scripts/core/test_runner.sh --all
      - name: Generate report
        run: ./test-framework/scripts/core/test_runner.sh --report markdown
```

### 2. 质量门禁配置

```yaml
# test-framework/config/test_config.yml
quality_gates:
  min_pass_rate: 90
  max_response_time: 1000
  max_error_rate: 0.05
  critical_issues_allowed: 0
```

### 3. 自动化报告生成

```bash
# 生成多种格式报告
./test-runner.sh --report markdown
./test-runner.sh --report html
./test-runner.sh --report json

# 发送测试报告
cat reports/test_report_*.md | mail -s "测试报告" team@example.com
```

## 故障排除指南

### 1. 常见问题

**服务启动失败：**
```bash
# 检查端口占用
netstat -tlnp | grep 8080

# 检查Java进程
ps aux | grep java

# 查看应用日志
tail -f target/spring-boot-app.log
```

**数据库连接失败：**
```bash
# 测试数据库连接
mysql -h localhost -u root -p123456 -e "USE web_order; SELECT 1;"

# 检查数据库状态
systemctl status mysql
```

**测试脚本权限问题：**
```bash
# 赋予执行权限
chmod +x test-framework/scripts/**/*.sh

# 检查文件权限
ls -la test-framework/scripts/
```

### 2. 调试模式

```bash
# 启用详细调试
export DEBUG_TEST_FRAMEWORK=1
./test_runner.sh --all --debug

# 只显示错误信息
./test_runner.sh --all --errors-only

# 查看详细日志
tail -f test-framework/scripts/core/logs/test_framework.log
```

### 3. 性能优化

**测试执行优化：**
```bash
# 启用并行测试
export TEST_PARALLEL=4
./test_runner.sh --all --parallel

# 启用数据缓存
export TEST_DATA_CACHE=1
./test_runner.sh --all --cache
```

**内存和CPU优化：**
```bash
# 限制并发数
export TEST_MAX_CONCURRENT=10
./test_runner.sh --all

# 分批执行测试
./test_runner.sh --type api
./test_runner.sh --type security
./test_runner.sh --type database
./test_runner.sh --type integration
```

## 最佳实践

### 1. 测试数据管理

```bash
# 初始化测试数据
./test-framework/scripts/core/data_manager.sh init

# 创建测试快照
./test-framework/scripts/core/data_manager.sh snapshot before_tests

# 恢复测试快照
./test-framework/scripts/core/data_manager.sh restore before_tests

# 清理测试数据
./test-framework/scripts/core/data_manager.sh clean
```

### 2. 测试报告分析

```bash
# 生成趋势分析报告
./test-runner.sh --report markdown --trend

# 比较不同版本的测试结果
./test-runner.sh --compare v1.0 v1.1

# 导出测试数据
./test-framework/scripts/core/data_manager.sh export backup.sql
```

### 3. 持续改进

1. **定期执行测试**：建立定期的测试执行机制
2. **分析失败原因**：及时分析测试失败的原因并修复
3. **优化测试覆盖**：根据测试结果不断改进测试覆盖范围
4. **监控性能趋势**：关注性能指标的变化趋势

---

**文档版本**: 1.0
**最后更新**: 2025-09-17
**维护者**: Web订餐管理系统开发团队